
# DataRock Integration Guide

## I. Initiate OAuth2 Single-SignOn
The first step in the process is to initiate an OAuth2 SSO process with DataRock.  This is accomplished by either redirecting the current browser window or openning a new pop-up browser window, but in either case the user is presented with the DataRock authorization page.

To initiate OAuth2 SSO, direct the client to the following page:
```
GET https://auth.datarock.com/authorize?
  response_type=code&
  client_id={my client id}&
  redirect_uri={my login handler URL}&
  scope=openid {and any other desired scopes}&
  code_challenge={a generated token}&
  code_challenge_method=S256&
  state={whatever I need}
```
| Parameter | Definition |
|--|--|
| `response_type` | Selects the desired OAuth2 flow.  In almost all cases, the value `code` should be used to select the authorization code flow. |
| `client_id` | Your client application's assigned identifier. |
| `redirect_uri` | Your client application's URL that will handle incoming SSO logins. |
| `scope` | A space-separated list of all claims your client wishes to the authorized to access by the user. |
| `code_challenge` | A URL-safe base64-encoded hash of a random number generated by the client for this login attempt.  This will be used to prevent man-in-the-middle attacks. |
| `code_challenge_method` | The hashing method used to generate the `code_challenge`.  The spec allows for either `S256` (SHA-256) or `plain`, but `S256` is the more secure option and should be used in all cases. |
| `state` | Any value the client application needs to record the current state of the user session.  Typically used to record the page the user is trying to access. |

Note: URL Safe Base 64-encoded hash can be aquired by replacing `+` with `-`, `/` with `_` and remove `=`.
Example code: `crypto.createHash('sha256').update(CODE_VERIFIER).digest('base64').replace(/\+/g, '-').replace(/\//, '_').replace(/=/, '')` 

## II. Receive the SSO Response
Once the user completes the OAuth2 SSO process, the browser will be redirected back to the specified `redirect_uri` with either a token that can be used to authenticate the user, or error details if an error occurred.

For example, assume a `redirect_uri` value of `https://my.app/my/handler`.  A successful SSO flow will result in a request of the pattern:

* `https://my.app/my/handler?code={some opaque token value}`

And an unsuccessful SSO flow will result in a request of the pattern:

* `https://my.app/my/handler?error={some error code}&error_description={some human-readable error description}`

### III. Issue Access Token Request
Once the SSO flow as completed successfully and your login handler has received an authorization code, you must call the DataRock token service to receive bearer token credentials for the user.  The DataRock token service is accessible via the request pattern:

```
Authorization: Basic {my client's id and secret}
POST https://api.datarock.com/token
  grant_type=authorization_code&
  code={the received authorization code}&
  code_verifier={the value used to generate the `code_challenge`}&
  redirect_uri={the initially-supplied handler URL}
```
| Parameter | Definition |
|--|--|
| `Authorization` | A standard HTTP Basic authorization header containing the client's id and secret, concatenated with a colon and Base64-encoded (e.g. `base64(id + ':' + secret)`). |
| `grant_type` | Indicates the token process being requested, in this case `authorization_code` to indicate you are supplying an authorization code. |
| `code` | The authorization code recieved by the client application's login handler. |
| `code_verifier` | The raw random value that was generated by the client and used to generate the `code_challenge` provided in the initial SSO request. |
| `redirect_uri` | The same value supplied in the initial SSO request. |

In response to this request, DataRock will replay with a standard OAuth2 Access Token Response.  This will follow the pattern:

```
{
	"access_token":"{the supplied bearer token}",
	"token_type":"access",
	"expires_in":{some integer number},
	"refresh_token":"{the supplied refresh token}",
	"scope":"{value provided by client}",
	"id_token":"{the supplied id token}"
}
```
| Parameter | Definition |
| -- | -- |
| `access_token` | A bearer token that can be used to request resources on this user's behalf. |
| `token_type` | Indicates the returned token is an access token. |
| `expires_in` | The number of seconds for which the access token is valid, after which time the supplied refresh token should be used to request a new access token. |
| `refresh_token` | A token that can be used to request updated credentials. |
| `scope` | Whatever value was supplied to DataRock in the initial SSO request. |
| `id_token` | An OpenID Connect ID token, which provides details about the authenticated user and the approved claims. |

## IV. Inspect the ID Token
The provided ID token is a JWT that contains several useful pieces of information for you client.  Instructions for parsing the JWT are outside the scope of this document, but a good introduction can be found at [JWT.io](https://jwt.io/).  Once you have parsed the ID token, you will find the following document pattern:

```
{
	"iss":"https://auth.datarock.com",
	"sub":"{the user id}",
	"aud":"{your client id}"
	"exp":"{timestamp when token is no longer valid}",
	"iat":"{timestamp when token was issued}",
	"claims":"{list of all approved scopes}"
}
```

| Parameter | Definition |
| -- | -- |
| `iss` | The issuer of the token - aka DataRock. |
| `sub` | The unique DataRock identifier of the authenticated user. |
| `aud` | The client or client[s] for whom this token was issued. |
| `exp` | An RFC3339-formatted timestamp for when this token should no longer be considered valid. |
| `iat` | An RDC3339-formatted timestamp for when this token was issued. |
| `claims` | A space-separated list of all scope claims which have been approved by this user for the requesting client. |

The two primary values in the ID token to consider are the `sub` and the `claims` parameters.  The `sub` provides a consistent identifier your application should use to identify the user, and the `claims` parameter indicates all of the approved scopes which this client may request on this user’s behalf.

## V. Retrieive UserInfo
If necessary, you may also use the supplied access bearer token to retrieve the user’s PII information from DataRock.  User information may be requested via the OpenID Connect standard UserInfo service, which follows the request pattern:

```
Authorization: Bearer {access token}
GET/POST https://api.datarock.com/userinfo
```

| Parameter | Definition |
| — | — |
| `Authorization` | A standard Bearer authorization header that includes the provided access token. |

This service returns a UserInfo response as specified by OpenID Connect at [OpenID Connect Standard Claims](https://openid.net/specs/openid-connect-core-1_0.html#StandardClaims).
